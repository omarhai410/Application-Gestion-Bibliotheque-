<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Gestion de Bibliothèque</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@4.3.0/dist/wavesurfer.min.js"></script>

</head>


    <style>

         #bookSearch {
        max-width: 800px; /* Adjust the max-width as needed */
        margin: 0 auto; /* Center the container */
    }

    #searchForm {
        margin-left: auto; /* Move the form to the right */
    }

    @media (max-width: 767px) {
        /* Apply a responsive layout on smaller screens */
        #searchForm {
            margin-left: 0; /* Reset margin for smaller screens */
        }
    }


      .custom-badge {
            background-color: #ffc107; /* Set the background color */
            color: #212529; /* Set the text color */
            font-size: 14px; /* Set the font size */
            font-weight: bold; /* Set the font weight */
            padding: 6px 10px; /* Set the padding */
            border-radius: 50%; /* Make it a circle */
        }

      pdf-icon {
        color: red;
        border: none;
    }
        .form-container {
            margin-top: 50px;
        }
        body {
            padding-top: 56px;
            margin: 0; /* Élimine la marge par défaut du corps */
            padding: 0; /* Élimine le remplissage par défaut du corps */

        }
        nav {
            background-color: #28a745;
            padding: 15px;
            position: fixed;
            height: 100%;
            width: 250px;
        }
        nav a {
            color: #fff;
            margin-bottom: 10px;
        }
        section {
            margin-left: 250px;
            padding: 20px;
        }
        footer {
            background-color: #f8f9fa;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .custom-margin-left {
    margin-left: 150px; /* ou n'importe quelle valeur que vous préférez */
}

        header {
            height: 80px;
            width: 100%;
            display: flex;
            align-items: center; /* Centre verticalement les éléments dans le header */
        }

       #emprunterForm {
    display: none;  /* Masquer le formulaire par défaut */
    margin-top: 20px;  /* Ajouter une marge en haut pour l'espacement */
    margin-left: auto; /* Déplacer le formulaire vers la droite */
    margin-right: auto; /* Déplacer le formulaire vers la gauche */
    max-width: 800px;  /* Ajuster la largeur maximale selon vos besoins */
}


/* Optionally, you can add some spacing between the form rows */
#emprunterForm .form-row {
    margin-bottom: 15px;
}

 audio::-webkit-media-controls-panel {
            background-color: #25D366;
            border: 2px solid #333;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            text-align: center;
            color: #ffffff;
        }

        audio::-webkit-media-controls-play-button {
            background-color: gray;
            border-radius: 50%;
        }

        audio::-webkit-media-controls-current-time-display {
            color: gray;
        }

        audio::-webkit-media-controls-time-remaining-display {
            display: none;
        }

        audio::cue {
            display: none;
        }
form-group {
        margin-bottom: 15px;
    }

    #textMessageInput,
    #audioMessageInput,
    #fileMessageInput {
        display: none;
    }





    </style>
</html>
<body>
    <div class="container-fluid">
        <!-- Navigation Menu -->
<nav class="navbar navbar-dark bg-primary flex-column fixed-top">
            <a class="navbar-brand" href="#"><i class="fas fa-book"></i> Menu</a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('rechercheLivres')">Recherche de Livres</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('bibliotheque')">Bibliothèque</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('emprunterLivres')">Emprunter des Livres</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('retourLivres')">Retour de Livres</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('notifications')">Notifications</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('reservations')">Réservations</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('compteUtilisateur')">Compte Utilisateur</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('aideSupport')">Aide et Support</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="logout()">Déconnexion</a>
                </li>
            </ul>
        </nav>
    </div>

    <header class="bg-white shadow custom-margin-left">
    <div class="container d-flex align-items-center justify-content-center">
        <div>
            <form class="form-inline">
                <input class="form-control mr-sm-2" type="search" placeholder="Rechercher" aria-label="Search">
                <button class="btn btn-outline-dark my-2 my-sm-0" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
        <div class="ml-auto text-right">
            <a href="#" class="text-dark ml-3">
                <i class="fas fa-bell"></i> Boîte de Notification
            </a>
            <a href="#" class="text-dark ml-3">
                <i class="fas fa-envelope"></i> Boîte de Messagerie
            </a>
            <div class="dropdown d-inline ml-3">
                <a href="#" class="text-dark dropdown-toggle" id="profileDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user"></i> {{ session.username }}
                </a>
                <div class="dropdown-menu" aria-labelledby="profileDropdown">
                    <a class="dropdown-item" href="#">Profil</a>
                    <a class="dropdown-item" href="#">Paramètres</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{{ url_for('logout') }}">Déconnexion</a>
                </div>
            </div>
        </div>
    </div>
</header>
<section id="bookSearch" class="container my-4">
    <h1>Recherche de Livres</h1>

    <form action="/omar" method="post" class="shadow p-3 mb-5 bg-white rounded">
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="titre">Titre:</label>
                <input type="text" class="form-control" name="titre" id="titre">
            </div>
            <div class="form-group col-md-3">
                <label for="auteur">Auteur:</label>
                <input type="text" class="form-control" name="auteur" id="auteur">
            </div>
            <div class="form-group col-md-3">
                <label for="categorie">Catégorie:</label>
                <input type="text" class="form-control" name="categorie" id="categorie">
            </div>
            <div class="form-group col-md-3">
                <label for="source">Source:</label>
                <input type="text" class="form-control" name="source" id="source">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Rechercher</button>
    </form>

    {% if resultats %}
        <h2>Résultats de la recherche :</h2>
        <table class="table table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Titre</th>
                    <th>Auteur</th>
                    <th>Sommaire</th>
                    <th>Nombre de Pages</th>
                    <th>Catégorie</th>
                    <th>Source</th>
                    <th>Quantité</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for livre in resultats %}
                    <tr>
                        <td>{{ livre.titre }}</td>
                        <td>{{ livre.auteur }}</td>
                        <td>{{ livre.sommaire }}</td>
                        <td>{{ livre.nbr_pages }}</td>
                        <td>{{ livre.categorie }}</td>
                        <td>{{ livre.source }}</td>
                        <td>{{ livre.quantite }}</td>
                        <td>
                            <button class="btn btn-success" onclick="emprunterLivres('{{ livre._id }}')" data-livre-id="{{ livre._id }}">Emprunter</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</section>


    <section id="emprunterForm" class="container my-4" style="display: none;">
    <h1>Formulaire d'emprunt de livre</h1>

    <form action="/submit-emprunt" method="post" class="shadow p-3 mb-5 bg-white rounded">
        <!-- User Information -->
       <!-- User Information -->
<!-- User Information -->
<div class="form-row">
    {% if session.get('username') %}
        <div class="form-group col-md-6">
            <label for="nomUtilisateur">Nom de l'utilisateur:</label>
            <input type="text" class="form-control" name="nomUtilisateur" id="nomUtilisateur_{{ user_info.get('username', 'default') }}" value="{{ user_info.get('username', '') }}" readonly>
        </div>
        <div class="form-group col-md-6">
            <label for="emailUtilisateur">Email de l'utilisateur:</label>
            <input type="email" class="form-control" name="emailUtilisateur" id="emailUtilisateur_{{ user_info.get('email', 'default') }}" value="{{ user_info.get('email', '') }}" readonly>
        </div>
    {% else %}
        <div class="form-group col-md-6">
            <label for="nomUtilisateur">Nom de l'utilisateur:</label>
            <input type="text" class="form-control" name="nomUtilisateur" id="nomUtilisateur_default" readonly>
        </div>
        <div class="form-group col-md-6">
            <label for="emailUtilisateur">Email de l'utilisateur:</label>
            <input type="email" class="form-control" name="emailUtilisateur" id="emailUtilisateur_default" readonly>
        </div>
    {% endif %}
</div>





        <!-- Book Information -->
        <div class="form-row">
            <!-- Book Information -->
<div class="form-row">
    <div class="form-group col-md-6">
        <label for="livreTitre">Titre:</label>
        <input type="text" class="form-control" name="livreTitre" id="livreTitre" readonly>
    </div>
    <div class="form-group col-md-6">
        <label for="livreAuteur">Auteur:</label>
        <input type="text" class="form-control" name="livreAuteur" id="livreAuteur" readonly>
    </div>
    <div class="form-group col-md-12">
        <label for="livreSommaire">Sommaire:</label>
        <textarea class="form-control" name="livreSommaire" id="livreSommaire" readonly></textarea>
    </div>
    <div class="form-group col-md-6">
        <label for="livreNbrPages">Nombre de Pages:</label>
        <input type="text" class="form-control" name="livreNbrPages" id="livreNbrPages" readonly>
    </div>
    <div class="form-group col-md-6">
        <label for="livreCategorie">Catégorie:</label>
        <input type="text" class="form-control" name="livreCategorie" id="livreCategorie" readonly>
    </div>
    <div class="form-group col-md-6">
        <label for="livreSource">Source:</label>
        <input type="text" class="form-control" name="livreSource" id="livreSource" readonly>
    </div>
    <div class="form-group col-md-6">
        <label for="livreQuantite">Quantité:</label>
        <input type="text" class="form-control" name="livreQuantite" id="livreQuantite" readonly>
    </div>
</div>

        </div>

        <!-- Borrowing Details -->
      <div class="form-row">
    <div class="form-group col-md-6">
        <label for="dateEmprunt">Date d'emprunt:</label>
        <input type="date" class="form-control" name="dateEmprunt" id="dateEmprunt" oninput="calculateMaxReturnDate()" required>
    </div>
    <div class="form-group col-md-6">
        <label for="dateRetour">Date de retour:</label>
        <input type="date" class="form-control" name="dateRetour" id="dateRetour" oninput="validateReturnDate()" required>
    </div>
</div>
        <!-- Payment Details -->
        <div class="form-row">
         <div class="form-group col-md-6">
        <label for="nombreLivres">Nombre de livres:</label>
        <input type="number" class="form-control" name="nombreLivres" id="nombreLivres" oninput="updatePaymentAmount()" required>
    </div>
    <div class="form-group col-md-6">
        <label for="methodePaiement">Méthode de paiement:</label>
        <select class="form-control" name="methodePaiement" id="methodePaiement" onchange="handlePaymentMethod()" required>
            <option value="cash">Cash</option>
            <option value="carte">Carte bancaire</option>
        </select>
    </div>
        </div>
              <button type="submit" class="btn btn-primary">Emprunter</button>


<!-- Modal Alert -->
<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalLabel">Alerte</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                La date de retour ne peut pas dépasser 14 jours à partir de la date d'emprunt.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

   <!-- Premier modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Détails de paiement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>La méthode de calcul du montant total est la suivante :</p>
                <p>- Le prix par livre est déterminé en fonction du nombre de livres :</p>
                <p>&nbsp;&nbsp;&nbsp;&nbsp;- 100 € par livre pour moins de 2 livres,</p>
                <p>&nbsp;&nbsp;&nbsp;&nbsp;- 90 € par livre pour moins de 5 livres,</p>
                <p>&nbsp;&nbsp;&nbsp;&nbsp;- 75 € par livre pour 5 livres ou plus.</p>
                <p>- Le montant total est calculé en multipliant le nombre de livres par le nombre de jours d'emprunt par le prix par livre.</p>
                <div id="paymentDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="confirmerPaiement()">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<!-- Deuxième modal pour les détails de la carte de crédit -->
<div class="modal fade" id="creditCardModal" tabindex="-1" role="dialog" aria-labelledby="creditCardModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="creditCardModalLabel">Détails de la carte de crédit</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="creditCardNumber">Numéro de carte de crédit</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="creditCardNumber" placeholder="Numéro de carte">
                            <!-- Ajout de l'icône de la carte de crédit à l'intérieur de l'input -->
                            <div class="input-group-append">
                                <span class="input-group-text"><i class="fa fa-credit-card"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="expirationDate">Date d'expiration</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="expirationDate" placeholder="MM/AA">
                                <!-- Ajout de l'icône pour la date d'expiration à l'intérieur de l'input -->
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="securityCode">Code de sécurité (CVV/CVC)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="securityCode" placeholder="CVV/CVC">
                                <!-- Ajout de l'icône pour le CVC à l'intérieur de l'input -->
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fa fa-lock"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cardHolderName">Nom du titulaire de la carte</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="cardHolderName" placeholder="Nom du titulaire">
                            <label for="cardHolderEmail" class="sr-only">E-mail du titulaire de la carte</label>
                            <input type="email" class="form-control" id="cardHolderEmail" placeholder="E-mail du titulaire">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="countryRegion">Pays ou région</label>
                        <input type="text" class="form-control" id="countryRegion" placeholder="Pays ou région">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="submit" class="btn btn-primary" onclick="event.preventDefault(); soumettreDetailsCarte()">Soumettre</button>
            </div>
        </div>
    </div>
</div>





<div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Détails de paiement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="paymentDetails">
                <!-- Payment details will be dynamically populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
        <!-- Submit Button -->
    </form>
</section>






    <section id="bibliotheque" class="main-section">
        <!-- Content for Bibliothèque section -->
        <!-- Add your HTML content for this section -->
    </section>



    <script>
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            document.getElementById(sectionId).style.display = 'block';
        }
    </script>
    <script>
        function emprunterLivres(livreId) {
            console.log('Emprunter clicked for livre ID:', livreId);

            // Display the emprunterForm section
            document.getElementById('emprunterForm').style.display = 'block';

            // Fetch book details and populate the form fields
            fetchBookDetailsAndPopulateForm(livreId);
        }

       function fetchBookDetailsAndPopulateForm(livreId) {
              console.log('Fetching details for livre ID:', livreId);

    var table = document.querySelector('.table');
    var rows = table.querySelectorAll('tbody tr');

    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var id = row.cells[row.cells.length - 1].querySelector('button').getAttribute('data-livre-id');

        if (id === livreId) {
            // Extract book information from the table row
            var titre = row.cells[0].textContent;
            var auteur = row.cells[1].textContent;
            var sommaire = row.cells[2].textContent;
            var nbrPages = row.cells[3].textContent;
            var categorie = row.cells[4].textContent;
            var source = row.cells[5].textContent;
            var quantite = row.cells[6].textContent;

            // Update the form fields with the book information
            document.getElementById('livreTitre').value = titre;
            document.getElementById('livreAuteur').value = auteur;
            document.getElementById('livreSommaire').textContent = sommaire;  // Use textContent for textarea
            document.getElementById('livreNbrPages').value = nbrPages;
            document.getElementById('livreCategorie').value = categorie;
            document.getElementById('livreSource').value = source;
            document.getElementById('livreQuantite').value = quantite;

            // Display the emprunterForm section
            document.getElementById('emprunterForm').style.display = 'block';
            break;
        }
    }
}

    </script>

<!-- Add this script at the end of your HTML -->
<script src="https://code.jquery.com/jquery-3.6.4.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function calculateMaxReturnDate() {
        const empruntDate = new Date(document.getElementById('dateEmprunt').value);

        const maxReturnDate = new Date(empruntDate);
        maxReturnDate.setDate(empruntDate.getDate() + 14);

        const formattedMaxReturnDate = maxReturnDate.toISOString().split('T')[0];

        document.getElementById('dateRetour').value = formattedMaxReturnDate;
    }

    function validateReturnDate() {
        const returnDate = new Date(document.getElementById('dateRetour').value);

        const currentDate = new Date();

        const maxAllowedReturnDate = new Date(currentDate);
        maxAllowedReturnDate.setDate(currentDate.getDate() + 14);

        if (returnDate > maxAllowedReturnDate) {
            $('#alertModal').modal('show');
        } else {
            $('#alertModal').modal('hide');
        }
    }
</script>
<script>
    function updatePaymentAmount() {
        // Get the selected number of books
        const numberOfBooks = parseInt(document.getElementById('nombreLivres').value);

        // Get the selected payment method
        const paymentMethod = document.getElementById('methodePaiement').value;

        // Calculate the price per book based on the conditions provided
        let pricePerBook;
        if (numberOfBooks < 2) {
            pricePerBook = 100;
        } else if (numberOfBooks < 5) {
            pricePerBook = 90;
        } else {
            pricePerBook = 75;
        }

        // Get the selected date of return and date of emprunt
        const returnDate = new Date(document.getElementById('dateRetour').value);
        const empruntDate = new Date(document.getElementById('dateEmprunt').value);

        // Calculate the number of days between return date and emprunt date
        const numberOfDays = Math.ceil((returnDate - empruntDate) / (1000 * 60 * 60 * 24));

        // Calculate the total payment amount
        const totalPaymentAmount = numberOfBooks * numberOfDays * pricePerBook;

        // Display the payment amount in the modal
        document.getElementById('paymentDetails').innerHTML = `Montant total : ${totalPaymentAmount} €`;
    }

    function handlePaymentMethod() {
        // Get the selected payment method
        const paymentMethod = document.getElementById('methodePaiement').value;

        // If the payment method is "Carte bancaire", show the payment details modal
        if (paymentMethod === 'carte') {
            $('#paymentModal').modal('show');
            // Update the payment amount when the modal is shown
            updatePaymentAmount();
        }
    }
</script>

<script>
    function confirmerPaiement() {
        $('#creditCardModal').modal('show');
    }


</script>
<script>
  function soumettreDetailsCarte() {
    // Récupérez les détails nécessaires
    const creditCardNumber = document.getElementById('creditCardNumber').value;
    const expirationDate = document.getElementById('expirationDate').value;
    const securityCode = document.getElementById('securityCode').value;
    const cardHolderName = document.getElementById('cardHolderName').value;
    const cardHolderEmail = document.getElementById('cardHolderEmail').value;
    const countryRegion = document.getElementById('countryRegion').value;
    const numberOfBooks = parseInt(document.getElementById('nombreLivres').value);
    const totalPaymentAmount = document.getElementById('paymentDetails').textContent;

    // Construisez l'objet de données que vous souhaitez envoyer au serveur
    const data = {
        creditCardNumber,
        expirationDate,
        securityCode,
        cardHolderName,
        cardHolderEmail,
        countryRegion,
        numberOfBooks,
        totalPaymentAmount
    };

    // Effectuez une requête XMLHttpRequest pour envoyer les données au serveur
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/envoyer-email', true);
    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onload = function () {
        if (xhr.status === 200) {
            // Succès de la requête
            console.log(xhr.responseText);
        } else {
            // Gestion des erreurs
            console.error(xhr.statusText);
        }

        // Fermez le deuxième modal
        const creditCardModal = document.getElementById('creditCardModal');
        const modalInstance = bootstrap.Modal.getInstance(creditCardModal);
        modalInstance.hide();
    };

    // Envoyer les données JSON transformées en chaîne
    xhr.send(JSON.stringify(data));
}

</script>
<div class="container mt-3" style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
    <div class="row justify-content-start" >
        <div class="col-md-8">
            <div class="card" style="background-color: #f2f2f2">
                <div class="card-header bg-success text-white text-center"style="border: 1px solid black;">
                    <img src="{{ url_for('static', filename='mimoun.png') }}" class="rounded-circle float-left mr-3" alt="User Photo" style="width: 100px; height: 100px;">
                    <div class="text-left">
                        <h5 class="card-title">MIMOUNE HOUBAOUI</h5>
 <p>Last seen: {{ user_info.formatted_date }}</p>
``
    </div>
                </div>
                <div class="card-body chat-container"style="border: 1px solid black;">
                    <div class="text-center mb-4">
                        <p class="card-text">Administrateur et Gestionnaire Multimédia de ENS-AH-IIE BIBLIO</p>
                    </div>

                    <div id="chatMessages" class="mb-3"></div>
                    <form id="chatForm" class="d-flex flex-column align-items-start" onsubmit="return validateForm()">
                        <div class="form-row mb-3">
                            <div class="form-group col-md-3">
                                <label for="userName"></label>
                                <input type="text" class="form-control" id="userName" value="{{ user_info.username }}" readonly form="chatForm">
                            </div>
                            <div class="form-group col-md-3">
                                <label for="messageType"></label>
                                <select class="form-control" id="messageType" form="chatForm">
                                    <option value="text"><i class="fas fa-comment"></i> Text</option>
                                    <option value="audio"><i class="fas fa-microphone"></i> Audio</option>
                                    <option value="file"><i class="fas fa-file"></i> File</option>
                                </select>
                            </div>
                        </div>

                      <div id="textMessageInput" class="form-group col-md-12">
                           <label for="textMessage"></label>
                           <textarea class="form-control" id="textMessage" rows="3" form="chatForm"></textarea>
                      </div>




                        <div id="audioMessageInput" class="form-group col-md-12">
                            <label for="audioMessage"></label>
                            <div class="audio-container d-flex align-items-center">
                                <canvas id="frequencyCanvas" style="width: 50px; height: 50px; border: 1px solid #ccc;"></canvas>
                                <div class="ml-3">
                                    <audio id="audioMessage" controls class="mw-100 custom-audio"
                                        style="background-color: #f0f0f0; border: 2px solid #333; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); font-family: 'Arial', sans-serif; font-size: 16px; text-align: center; background:#25D366; color: #ffffff;">
                                    </audio>
                                </div>
                                <div class="ml-3">
                                    <button id="startButton" class="btn btn-primary rounded-circle" onclick="startRecording()"
                                        style="background-color: #4CAF50;">
                                        <i class="fas fa-play-circle"></i>
                                    </button>
                                    <button id="stopButton" class="btn btn-danger ml-2 rounded-circle" onclick="stopRecording()"
                                        style="display: none; background-color: #4CAF50;">
                                        <i class="fas fa-stop-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="fileMessageInput" class="form-group col-md-12">
                            <label for="fileMessage"></label>
                            <div class="input-group">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="fileMessage" accept=".txt, .pdf, .doc, .docx" form="chatForm">
                                    <label class="custom-file-label" for="fileMessage" id="fileLabel">Choose file</label>
                                </div>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="inputGroupFileAddon"><i class="fas fa-paperclip"></i></span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.getElementById('startButton').addEventListener('click', startRecording);
    document.getElementById('stopButton').addEventListener('click', stopRecording);

    function validateForm() {
    const messageType = messageTypeSelect.value;

    if (messageType === 'text') {
        const textMessage = textMessageTextarea.value.trim();
        if (textMessage === '') {
            alert('Please enter a text message.');
            return false;
        }
    }


    return true;

}

</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const chatForm = document.getElementById('chatForm');
    const chatMessages = document.getElementById('chatMessages');
    const userNameInput = document.getElementById('userName');
    const messageTypeSelect = document.getElementById('messageType');
    const audioMessageInput = document.getElementById('audioMessageInput');
    const fileMessageInput = document.getElementById('fileMessageInput');
    const textMessageTextarea = document.getElementById('textMessage');


 const uniqueMessages = [];

chatForm.addEventListener('submit', function (event) {
    event.preventDefault();

    const userName = userNameInput.value;
    const messageType = messageTypeSelect.value;

    let messageContent;

    if (messageType === 'text') {
        messageContent = textMessageTextarea.value;
    } else if (messageType === 'audio') {
        messageContent = audioMessage.src;
        sendAudioMessageToServer(messageContent);

        // Skip displaying audio messages with specific content or empty content
if (messageContent === 'http://127.0.0.1:502/omar' || messageContent === '') {
    return;
}

    } else if (messageType === 'file') {
        const fileInput = document.getElementById('fileMessage');
        messageContent = fileInput.files[0].name;
        sendFileMessageToServer(messageContent);
    }

    // Check if the messageContent is already in the uniqueMessages array
    if (uniqueMessages.includes(messageContent)) {
        return; // Skip displaying duplicate messages
    }

    // Retrieve and sort messages by timestamp
fetch('/send_message')
    .then(response => response.json())
    .then(data => {
        const messages = data.messages;

        // Sort messages by timestamp in ascending order
        messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        // Clear existing messages in the chatMessages container
        chatMessages.innerHTML = '';

        // Append sorted messages to the chatMessages container
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong>${message.user_name}:</strong> `;

            // Display audio content under an audio element
            if (message.message_type === 'audio') {
                const audioElement = document.createElement('audio');
                audioElement.controls = true;
                audioElement.src = message.message_content;

                // Append the audio element
                messageElement.appendChild(audioElement);
            } else {
                // Display text or file content directly
                messageElement.innerHTML += `${message.message_content} (${message.message_type})`;
            }

            chatMessages.appendChild(messageElement);
        });
    })
    .catch(error => console.error('Error retrieving messages:', error));

        textMessageTextarea.value = '';
        audioMessage.src = '';
        fileMessage.value = '';
        fileLabel.textContent = 'Choose file';

        audioMessageInput.style.display = messageType === 'audio' ? 'block' : 'none';
        fileMessageInput.style.display = messageType === 'file' ? 'block' : 'none';
    });

    messageTypeSelect.addEventListener('change', function () {
    const messageType = messageTypeSelect.value;

    textMessageInput.style.display = messageType === 'text' ? 'block' : 'none';
    audioMessageInput.style.display = messageType === 'audio' ? 'block' : 'none';
    fileMessageInput.style.display = messageType === 'file' ? 'block' : 'none';
});


    function sendAudioMessageToServer(audioContent) {
        const formData = new FormData();
        formData.append('user_name', userNameInput.value);
        formData.append('message_type', 'audio');
        formData.append('message_content', audioContent);

        fetch('/send_message', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('Error sending audio message:', error));
    }

    function sendFileMessageToServer(fileContent) {
        const formData = new FormData();
        formData.append('user_name', userNameInput.value);
        formData.append('message_type', 'file');
        formData.append('message_content', fileContent);

        fetch('/send_message', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('Error sending file message:', error));
    }

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let audioUrl;
    let audioContext;
    let analyser;
    let canvas;
    let canvasContext;
    document.getElementById("startButton").addEventListener("click", startRecording);
    document.getElementById("stopButton").addEventListener("click", stopRecording);

    async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.addEventListener("dataavailable", event => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        });

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.connect(audioContext.destination);

        mediaRecorder.addEventListener("stop", () => {
            audioBlob = new Blob(audioChunks, { type: "audio/mpeg" });
            audioUrl = URL.createObjectURL(audioBlob);
            audioMessage.src = audioUrl;
            audioMessage.play();
        });

        mediaRecorder.start();
        document.getElementById("startButton").style.display = "none";
        document.getElementById("stopButton").style.display = "inline-block";

        const source = audioContext.createMediaElementSource(audioMessage);
        source.connect(analyser);
        source.connect(audioContext.destination);

        canvas = document.getElementById("frequencyCanvas");
        canvasContext = canvas.getContext("2d");
        drawFrequency();
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById("startButton").style.display = "inline-block";
            document.getElementById("stopButton").style.display = "none";
        }
    }

    function drawFrequency() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        analyser.getByteFrequencyData(dataArray);

        canvasContext.clearRect(0, 0, canvas.width, canvas.height);
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i];

            canvasContext.fillStyle = `rgb(0, ${barHeight + 100}, 0)`;
            canvasContext.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);

            x += barWidth + 1;
        }

        requestAnimationFrame(drawFrequency);
    }
});

</script>
  <script>
       function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sendLocation, handleLocationError);
    } else {
        alert("La géolocalisation n'est pas prise en charge par votre navigateur.");
    }
}

function sendLocation(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;

    console.log(`Latitude: ${latitude}, Longitude: ${longitude}`);

    fetch('/store-location', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ latitude, longitude }),
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Erreur lors de l\'envoi de la localisation:', error));
}

function handleLocationError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            alert("Vous avez refusé la demande de géolocalisation.");
            break;
        case error.POSITION_UNAVAILABLE:
            alert("L'emplacement n'est pas disponible.");
            break;
        case error.TIMEOUT:
            alert("La demande de géolocalisation a expiré.");
            break;
        case error.UNKNOWN_ERROR:
            alert("Une erreur inconnue s'est produite.");
            break;
    }
}

getLocation();

    </script>
</body>


</html>
